<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–ì–¥–µ –Ω–∞–π—Ç–∏ —Å–≤–æ—ë –¢–µ–ø–ª–æ</title>
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Times New Roman', Courier, Verdana,sans-serif;height:100vh;display:flex;flex-direction:column;}
.header{background-color:#361909;color:#f2e4dc;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.header h1{font-size:1.5rem;}
.search-container{position:relative;width:100%;max-width:400px;}
.search-box{width:100%;padding:10px 15px;border:none;border-radius:20px;font-size:1rem;}
.filter-container{background-color:#f5f5f5;padding:10px 20px;display:flex;flex-wrap:wrap;gap:10px;border-bottom:1px solid #ddd;align-items:center;}
.filter-btn{background-color:white;border:1px solid #ddd;border-radius:20px;padding:5px 15px;cursor:pointer;transition:all 0.3s;}
.filter-btn:hover,.filter-btn.active{background-color:#3c1b0b;color:white;}
#metro-filter{padding:5px 10px;border-radius:300px;border:1px solid #ccc;}
.main-content{display:flex;flex:1;height:calc(100vh - 100px);}
.sidebar{width:300px;background-color:white;border-right:1px solid #ddd;overflow-y:auto;display:flex;flex-direction:column;}
.coffee-list{list-style:none;padding:0;margin:0;}
.coffee-item{padding:15px;border-bottom:1px solid #eee;cursor:pointer;transition:0.2s;}
.coffee-item:hover{background-color:#f9f9f9;}
.coffee-item.active{background-color:#f0e6d8;}
.coffee-name{font-weight:bold;color:#3c1b0b;margin-bottom:5px;}
.coffee-address{font-size:0.9rem;color:#666;}
.coffee-rating{color:#ff9800;margin-top:5px;}
#map{flex:1;height:100%;}
.balloon-scroll{max-height:80vh;overflow-y:auto;}
.balloon-content{padding:15px;}
.balloon-header{font-size:1.2rem;font-weight:bold;margin-bottom:10px;color:#3c1b0b;}
.balloon-address{color:#666;margin-bottom:10px;font-size:0.9rem;}
.balloon-description{margin-bottom:15px;line-height:1.4;}
.balloon-rating{margin-bottom:10px;color:#ff9800;}
.balloon-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:15px;}
.balloon-btn{background-color:#f2e4dc;color:#3c1b0b;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;}
.telegram-embed{width:100%;height:300px;border:none;}
.user-location-btn{position:absolute;right:20px;bottom:30px;background-color:white;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 1px 5px rgba(0,0,0,0.3);cursor:pointer;z-index:1000;display:flex;justify-content:center;align-items:center;}

/* üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –±–∞–ª—É–Ω–æ–≤ */
.ymaps-2-1-79-balloon {
  max-width: 95vw !important;
  border-radius: 12px !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25) !important;
}

.ymaps-2-1-79-balloon__content {
  max-width: 90vw !important;
  max-height: 70vh !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
  padding: 10px;
  box-sizing: border-box;
  word-wrap: break-word;
}

.ymaps-2-1-79-balloon__close {
  right: 8px !important;
  top: 8px !important;
}

@media(max-width:768px){
  .main-content{flex-direction:column;}
  .sidebar{width:100%;height:200px;border-right:none;border-bottom:1px solid #ddd;}
  .header{flex-direction:column;gap:10px;}
  .search-container{max-width:100%;}
  .filter-container{overflow-x:auto;flex-wrap:nowrap;}
}
</style>
</head>
<body>

<div class="header">
  <h1 style="display:flex; align-items:center; gap:10px;">
    <img src="https://github.com/maksdecept97-crypto/coffeemap/blob/main/logo1.png?raw=true" 
         alt="–õ–æ–≥–æ—Ç–∏–ø" 
         style="height:75px; width:auto; display:block;"
         loading="lazy">
    –ì–¥–µ –Ω–∞–π—Ç–∏ —Å–≤–æ—ë –¢–µ–ø–ª–æ
  </h1>
  <div class="search-container">
    <input type="text" class="search-box" placeholder="–ü–æ–∏—Å–∫ –∫–æ—Ñ–µ–µ–Ω...">
  </div>
</div>

<div class="filter-container">
  <button class="filter-btn active" data-filter="all">–í—Å–µ</button>
  <button class="filter-btn" data-filter="center">–í —Ü–µ–Ω—Ç—Ä–µ</button>
  <button class="filter-btn" data-filter="with-food">–° –µ–¥–æ–π</button>
  <select id="metro-filter">
    <option value="">–ú–µ—Ç—Ä–æ (–≤—ã–±–µ—Ä–∏—Ç–µ)</option>
    <option value="59.935497, 30.327139">–ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç</option>
    <option value="59.927636, 30.347917">–í–ª–∞–¥–∏–º–∏—Ä—Å–∫–∞—è</option>
    <option value="59.956157, 30.318796">–ì–æ—Ä—å–∫–æ–≤—Å–∫–∞—è</option>
    <option value="59.944542, 30.359965">–ß–µ—Ä–Ω—ã—à–µ–≤—Å–∫–∞—è</option>
    <option value="59.916351, 30.318347">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∏–Ω—Å—Ç–∏—Ç—É—Ç</option>
    <option value="59.907422, 30.299664">–ë–∞–ª—Ç–∏–π—Å–∫–∞—è</option>
    <option value="59.966444, 30.311421">–ü–µ—Ç—Ä–æ–≥—Ä–∞–¥—Å–∫–∞—è</option>
    <option value="59.931779, 30.360737">–ü–ª.–í–æ—Å—Å—Ç–∞–Ω–∏—è</option>
    <option value="59.942520, 30.278278">–í–∞—Å–∏–ª–µ–æ—Å—Ç—Ä–æ–≤—Å–∫–∞—è</option>
    <option value="59.926912, 30.318882">–°–µ–Ω–Ω–∞—è/–°–∞–¥–æ–≤–∞—è/–°–ø–∞—Å—Å–∫–∞—è</option>
    <option value="59.935962, 30.314754">–ê–¥–º–∏—Ä–∞–ª—Ç–µ–π—Å–∫–∞—è</option>
    <option value="59.931233, 30.354801">–ú–∞—è–∫–æ–≤—Å–∫–∞—è</option>
  </select>
</div>

<div class="main-content">
  <div class="sidebar"><ul class="coffee-list"></ul></div>
  <div id="map"></div>
</div>

<button class="user-location-btn" title="–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"><i class="fas fa-location-arrow"></i></button>

<script>
ymaps.ready(init);
let map, coffeePlaces=[], userMarker=null, metroCircle=null, userCoords=null;

const coffeeData = [
  {id:1,name:"Tour Coffee",coordinates:[59.911946,30.316499],address:"7-—è –ö—Ä–∞—Å–Ω–æ–∞—Ä–º–µ–π—Å–∫–∞—è —É–ª., 5–î",description:"Tour coffee ‚Äî —ç—Ç–æ –ø—Ä–µ–¥–≤–∫—É—à–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π —Ä–∞–∑ —á–µ–≥–æ-—Ç–æ –Ω–æ–≤–æ–≥–æ: —Ä–∞–∑–Ω—ã–µ —Å–æ—Ä—Ç–∞, —Ä–∞–∑–Ω—ã–µ –æ–±–∂–∞—Ä—â–∏–∫–∏. –ó–¥–µ—Å—å –ø–æ–¥–∞—é—Ç –≥—Ä–∏–ª—å-—á–∏–∑—ã –∏ —Å–≤–µ–∂–∏–µ –¥–µ—Å–µ—Ä—Ç—ã. –ò –∫–æ–Ω–µ—á–Ω–æ –∫–æ—Ñ–µ.",telegramEmbed:"https://t.me/teplo_coffeeroutes/4?embed=1",tags:["center","with-food"]},
  {id:2,name:"UNIC",coordinates:[59.960012,30.311556],address:"—É–ª. –ö—Ä–æ–Ω–≤–µ—Ä—Å–∫–∞—è, 12",description:"UNIC ‚Äî –º–µ—Å—Ç–æ, –∫—É–¥–∞ —Ö–æ—á–µ—Ç—Å—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∑–∞ –µ–¥–æ–π –∏ –∫–æ—Ñ–µ.",telegramEmbed:"https://t.me/teplo_coffeeroutes/8?embed=1",tags:["center","with-food"]},
  {id:3,name:"Verl√©",coordinates:[59.963493, 30.314817],address:"–ö–∞–º–µ–Ω–Ω–æ–æ—Å—Ç—Ä–æ–≤—Å–∫–∏–π –ø—Ä-—Ç, 25/2",description:"–£—é—Ç–Ω–æ–µ –º–µ—Å—Ç–æ —Å –æ—Ç–ª–∏—á–Ω—ã–º –∫–æ—Ñ–µ –∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–æ–π.",telegramEmbed:"https://t.me/teplo_coffeeroutes/15?embed=1",tags:["center"]},
  {id:4,name:"–©–µ–≥–æ–ª",coordinates:[59.941899, 30.363427],address:"—É–ª. –†–∞–¥–∏—â–µ–≤–∞, 38/20",description:"–£—é—Ç–Ω–∞—è –∫–æ—Ñ–µ–π–Ω—è —Å —Ç—ë–ø–ª—ã–º, –¥–æ–º–∞—à–Ω–∏–º –¥–∏–∑–∞–π–Ω–æ–º, –∫—É–¥–∞ —Ö–æ—á–µ—Ç—Å—è –∑–∞—Ö–æ–¥–∏—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è –≥–æ–¥–∞.",telegramEmbed:"https://t.me/teplo_coffeeroutes/22?embed=1",tags:["center","with-food"]},
  {id:5,name:"Bolshecoffee roasters",coordinates:[59.927991, 30.353581],address:"—É–ª. –ú–∞—Ä–∞—Ç–∞, 22-2",description:"Bolshecoffee Roasters ‚Äî —ç—Ç–æ –º–µ—Å—Ç–æ, –≥–¥–µ –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è –∞—Ä–æ–º–∞—Ç–Ω—ã–º –∫–æ—Ñ–µ –∏ –≤–∫—É—Å–Ω—ã–º–∏ –¥–µ—Å–µ—Ä—Ç–∞–º–∏. –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ —à–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä –∫–æ—Ñ–µ–π–Ω—ã—Ö –∑–µ—Ä–µ–Ω.",telegramEmbed:"",tags:["center","with-food"]},
  {id:6,name:"–°–∏–±–∞—Ä–∏—Å—Ç–∏–∫–∞",coordinates:[59.910412, 30.284159],address:"–Ω–∞–±. –û–±–≤–æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞, 199-201–ö",description:"Sibaristica ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –±–æ–ª—å—à–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞, –≤ –∫–æ—Ç–æ—Ä–æ–µ –≤—Ö–æ–¥—è—Ç –∫–æ–≤–æ—Ä–∫–∏–Ω–≥ –∏ —à–∫–æ–ª–∞ –±–∞—Ä–∏—Å—Ç–∞. –í –º–µ–Ω—é –≤–æ—à–ª–∏ –ø–æ—á—Ç–∏ –¥–≤–∞ –¥–µ—Å—è—Ç–∫–∞ –≤–∏–¥–æ–≤ –∫–æ—Ñ–µ –æ—Ç –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä–Ω—ã—Ö –¥–æ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö ‚Äî –ª–∞—Ç—Ç–µ —Ä–æ–π–±—É—à, —Ä–∞—Ñ —Å–æ–ª–µ–Ω—ã–π –∞—Ä–∞—Ö–∏—Å, —Ñ–ª—ç—Ç —É–∞–π—Ç, –±–∞—Ä–∏—Å—Ç–∞-—Å–µ—Ç –∏–∑ —Ç—Ä–µ—Ö –Ω–∞–ø–∏—Ç–∫–æ–≤.",telegramEmbed:"https://t.me/teplo_coffeeroutes/35",tags:["with-food"]},
  {id:7,name:"–©–µ–≥–æ–ª",coordinates:[59.912521, 30.317260],address:"6-—è –ö—Ä–∞—Å–Ω–æ–∞—Ä–º–µ–π—Å–∫–∞—è —É–ª., 1",description:"–ü—Ä–∏—è—Ç–Ω–∞—è –∫–æ—Ñ–µ–π–Ω—è —Å –≤–∫—É—Å–Ω—ã–º –º–µ–Ω—é –∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–º –∫–æ—Ñ–µ.–ü—Ä–æ—Å—Ç–æ—Ä–Ω—ã–µ —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –¥–≤–µ—Ä–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞—Å–ø–∞—Ö–∏–≤–∞—é—Ç—Å—è –≤ —Ö–æ—Ä–æ—à—É—é –ø–æ–≥–æ–¥—É, –ø–æ–ª–∫–∞ –≤–æ –≤—Å—é —Å—Ç–µ–Ω—É —Å –º–æ–¥–Ω—ã–º–∏ –∂—É—Ä–Ω–∞–ª–∞–º–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ —Å—Ç–æ–ª–∏–∫–∏ –∏ —Å—Ç–∏–ª—å–Ω—ã–µ –ª–∞–º–ø—ã, –≥–∞—Ä–º–æ–Ω–∏—á–Ω–æ –≤–ø–∏—Å—ã–≤–∞—é—â–∏–µ—Å—è –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä.",telegramEmbed:"https://t.me/teplo_coffeeroutes/22?embed=1",tags:["with-food"]}
];

function init(){
  map = new ymaps.Map("map",{center:[59.93,30.34], zoom:12, controls:['zoomControl','geolocationControl']});
  addCoffeePlaces();
  renderCoffeeList();
  initEventHandlers();
  locateUser();
}

function addCoffeePlaces(){
  coffeeData.forEach(coffee => {
    const balloonContentBody = `
      <div class="balloon-scroll">
        <div class="balloon-content">
          <div class="balloon-header">${coffee.name}</div>
          <div class="balloon-address">${coffee.address}</div>
          <div class="balloon-description">${coffee.description}</div>
          ${coffee.telegramEmbed ? `<iframe class="telegram-embed" src="${coffee.telegramEmbed}"></iframe>` : ''}
          <div class="balloon-footer">
            <button class="balloon-btn" onclick="openRoute(${coffee.coordinates[0]},${coffee.coordinates[1]})">–ú–∞—Ä—à—Ä—É—Ç</button>
          </div>
        </div>
      </div>`;

    const placemark = new ymaps.Placemark(coffee.coordinates, {
      balloonContentHeader: coffee.name,
      balloonContentBody: balloonContentBody
    }, {
      iconLayout:'default#image',
      iconImageHref:'https://github.com/maksdecept97-crypto/coffeemap/blob/main/point.png?raw=true',
      iconImageSize:[18,28],
      iconImageOffset:[-20,-40]
    });

    coffeePlaces.push({id: coffee.id, placemark, data: coffee});
    map.geoObjects.add(placemark);
    placemark.events.add('click', () => { highlightCoffeeItem(coffee.id); });
  });
}

function renderCoffeeList(){
  const list=document.querySelector('.coffee-list');
  list.innerHTML='';
  coffeeData.forEach(coffee=>{
    const li=document.createElement('li');
    li.className='coffee-item'; li.dataset.id=coffee.id;
    li.innerHTML=`<div class="coffee-name">${coffee.name}</div><div class="coffee-address">${coffee.address}</div>`;
    li.addEventListener('click',()=>{
      const cp=coffeePlaces.find(c=>c.id===coffee.id);
      if(cp){map.setCenter(cp.placemark.geometry.getCoordinates(),16); cp.placemark.balloon.open(); highlightCoffeeItem(coffee.id);}
    });
    list.appendChild(li);
  });
}

function highlightCoffeeItem(id){
  document.querySelectorAll('.coffee-item').forEach(i=>i.classList.remove('active'));
  const selected=document.querySelector(`.coffee-item[data-id="${id}"]`);
  if(selected){selected.classList.add('active'); selected.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

function initEventHandlers(){
  document.querySelector('.search-box').addEventListener('input',applyFilters);
  document.querySelectorAll('.filter-btn').forEach(btn=>btn.addEventListener('click',function(){
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active');
    applyFilters();
  }));
  document.getElementById('metro-filter').addEventListener('change',applyFilters);
  document.querySelector('.user-location-btn').addEventListener('click',locateUser);
}

function applyFilters(){
  const searchText=document.querySelector('.search-box').value.toLowerCase();
  const activeFilter=document.querySelector('.filter-btn.active').dataset.filter;
  const metroVal=document.getElementById('metro-filter').value;
  const radiusMeters=800;
  let metroCoords=null;

  if(metroCircle){map.geoObjects.remove(metroCircle); metroCircle=null;}
  if(metroVal){
    metroCoords=metroVal.split(',').map(Number);
    metroCircle=new ymaps.Circle([metroCoords,radiusMeters],{}, {fillColor:'#DB709380',strokeColor:'#990066',strokeWidth:1});
    map.geoObjects.add(metroCircle);
  }

  coffeePlaces.forEach(cp=>{
    const name=cp.data.name.toLowerCase(), addr=cp.data.address.toLowerCase();
    let visible=true
        if(searchText && !name.includes(searchText) && !addr.includes(searchText)) visible=false;
    if(activeFilter!=='all' && !cp.data.tags.includes(activeFilter)) visible=false;
    if(metroCoords){
      const dist=ymaps.coordSystem.geo.getDistance(cp.data.coordinates,metroCoords);
      if(dist>radiusMeters) visible=false;
    }

    cp.placemark.options.set('visible',visible);
    const li=document.querySelector(`.coffee-item[data-id="${cp.id}"]`);
    if(li) li.style.display=visible?'block':'none';
  });
}

function locateUser(){
  if(!navigator.geolocation){alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º."); return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    userCoords=[pos.coords.latitude,pos.coords.longitude];
    addUserMarker(userCoords);
  },err=>{console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:",err); alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ.");},{enableHighAccuracy:true,timeout:5000});
}

function addUserMarker(coords){
  if(userMarker){map.geoObjects.remove(userMarker);}
  userMarker=new ymaps.Placemark(coords,{balloonContent:'–í—ã –∑–¥–µ—Å—å'},{preset:'islands#circleIcon',iconColor:'#3399ff'});
  map.geoObjects.add(userMarker); map.setCenter(coords,14,{duration:500});
}

// –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
function openRoute(lat, lon){
  if(!userCoords){
    alert("–°–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ!");
    return;
  }
  const url = `https://yandex.ru/maps/?rtext=${userCoords[0]},${userCoords[1]}~${lat},${lon}&rtt=auto`;
  window.open(url,'_blank');
}
</script>
</body>
</html>
