<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Где найти своё Тепло</title>
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Times New Roman', Courier, Verdana,sans-serif;height:100vh;display:flex;flex-direction:column;}
.header{background-color:#361909;color:#f2e4dc;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);}
.header h1{font-size:1.5rem;}
.search-container{position:relative;width:100%;max-width:400px;}
.search-box{width:100%;padding:10px 15px;border:none;border-radius:20px;font-size:1rem;}
.filter-container{background-color:#f5f5f5;padding:10px 20px;display:flex;flex-wrap:wrap;gap:10px;border-bottom:1px solid #ddd;align-items:center;}
.filter-btn{background-color:white;border:1px solid #ddd;border-radius:20px;padding:5px 15px;cursor:pointer;transition:all 0.3s;}
.filter-btn:hover,.filter-btn.active{background-color:#3c1b0b;color:white;}
#metro-filter{padding:5px 10px;border-radius:300px;border:1px solid #ccc;}
.sort-select{margin-left:auto;padding:5px 10px;border-radius:10px;border:1px solid #ccc;}
.main-content{display:flex;flex:1;height:calc(100vh - 100px);}
.sidebar{width:300px;background-color:white;border-right:1px solid #ddd;overflow-y:auto;display:flex;flex-direction:column;}
.coffee-list{list-style:none;padding:0;margin:0;}
.coffee-item{padding:15px;border-bottom:1px solid #eee;cursor:pointer;transition:0.2s;}
.coffee-item:hover{background-color:#f9f9f9;}
.coffee-item.active{background-color:#f0e6d8;}
.coffee-name{font-weight:bold;color:#3c1b0b;margin-bottom:5px;}
.coffee-address{font-size:0.9rem;color:#666;}
#map{flex:1;height:100%;}
.balloon-scroll{max-height:80vh;overflow-y:auto;}
.balloon-content{padding:15px;}
.balloon-header{font-size:1.2rem;font-weight:bold;margin-bottom:10px;color:#3c1b0b;}
.balloon-address{color:#666;margin-bottom:10px;font-size:0.9rem;}
.balloon-description{margin-bottom:15px;line-height:1.4;}
.balloon-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:15px;}
.balloon-btn{background-color:#f2e4dc;color:#3c1b0b;border:none;padding:8px 15px;border-radius:4px;cursor:pointer;}
.telegram-embed{width:100%;height:300px;border:none;}
.user-location-btn{position:absolute;right:20px;bottom:30px;background-color:white;border:none;border-radius:50%;width:40px;height:40px;box-shadow:0 1px 5px rgba(0,0,0,0.3);cursor:pointer;z-index:1000;display:flex;justify-content:center;align-items:center;}
@media(max-width:768px){.main-content{flex-direction:column;}.sidebar{width:100%;height:200px;border-right:none;border-bottom:1px solid #ddd;}.header{flex-direction:column;gap:10px;}.search-container{max-width:100%;}.filter-container{overflow-x:auto;flex-wrap:nowrap;}}
</style>
</head>
<body>

<div class="header">
  <h1 style="display:flex; align-items:center; gap:10px;">
    <img src="https://github.com/maksdecept97-crypto/coffeemap/blob/main/logo1.png?raw=true" 
         alt="Логотип" 
         style="height:75px; width:auto; display:block;"
         loading="lazy">
    Где найти своё Тепло
  </h1>
  <div class="search-container">
    <input type="text" class="search-box" placeholder="Поиск кофеен...">
  </div>
</div>

<div class="filter-container">
  <button class="filter-btn active" data-filter="all">Все</button>
  <button class="filter-btn" data-filter="center">В центре</button>
  <button class="filter-btn" data-filter="with-food">С едой</button>
  <select id="metro-filter">
    <option value="">Метро (выберите)</option>
    <option value="59.935497,30.327139">Невский проспект</option>
    <option value="59.927636,30.347917">Владимирская</option>
    <option value="59.956157,30.318796">Горьковская</option>
    <option value="59.944542,30.359965">Чернышевская</option>
    <option value="59.916351,30.318347">Технологический институт</option>
    <option value="59.907422,30.299664">Балтийская</option>
    <option value="59.966444,30.311421">Петроградская</option>
    <option value="59.931779,30.360737">Пл.Восстания</option>
    <option value="59.942520,30.278278">Василеостровская</option>
    <option value="59.926912,30.318882">Сенная/Садовая/Спасская</option>
    <option value="59.935962,30.314754">Адмиралтейская</option>
    <option value="59.931233,30.354801">Маяковская</option>
  </select>

  <!-- Новый селект для сортировки -->
  <select id="sort-select" class="sort-select">
    <option value="name">Сортировка: по названию</option>
    <option value="distance">Сортировка: ближайшие</option>
  </select>
</div>

<div class="main-content">
  <div class="sidebar"><ul class="coffee-list"></ul></div>
  <div id="map"></div>
</div>

<button class="user-location-btn" title="Мое местоположение"><i class="fas fa-location-arrow"></i></button>

<script>
ymaps.ready(init);
let map, coffeePlaces=[], userMarker=null, metroCircle=null, userCoords=null, clusterer;

const coffeeData = [
  {id:1,name:"Tour Coffee",coordinates:[59.911946,30.316499],address:"7-я Красноармейская ул., 5Д",description:"Tour coffee — это предвкушение чего-то нового: разные сорта, разные обжарщики. Здесь подают гриль-чизы и свежие десерты.",telegramEmbed:"https://t.me/teplo_coffeeroutes/4?embed=1",tags:["center","with-food"]},
  {id:2,name:"UNIC",coordinates:[59.960012,30.311556],address:"ул. Кронверская, 12",description:"UNIC — место, куда хочется приходить за едой и кофе.",telegramEmbed:"https://t.me/teplo_coffeeroutes/8?embed=1",tags:["center","with-food"]},
  {id:3,name:"Verlé",coordinates:[59.963493,30.314817],address:"Каменноостровский пр-т, 25/2",description:"Уютное место с отличным кофе и атмосферой.",telegramEmbed:"https://t.me/teplo_coffeeroutes/15?embed=1",tags:["center"]},
  {id:4,name:"Щегол",coordinates:[59.941899,30.363427],address:"ул. Радищева, 38/20",description:"Уютная кофейня с тёплым дизайном.",telegramEmbed:"https://t.me/teplo_coffeeroutes/22?embed=1",tags:["center","with-food"]},
  {id:5,name:"Bolshecoffee roasters",coordinates:[59.927991,30.353581],address:"ул. Марата, 22-2",description:"Место, где можно насладиться ароматным кофе и десертами.",telegramEmbed:"",tags:["center","with-food"]}
];

function init(){
  map = new ymaps.Map("map",{center:[59.93,30.34], zoom:12, controls:['zoomControl','geolocationControl']});
  clusterer = new ymaps.Clusterer({
    preset: 'islands#brownClusterIcons',
    groupByCoordinates: false,
    clusterDisableClickZoom: false,
    clusterOpenBalloonOnClick: true,
  });
  addCoffeePlaces();
  renderCoffeeList();
  initEventHandlers();
  locateUser();
}

// ✅ кастомные иконки + кластеризация
function addCoffeePlaces(){
  coffeeData.forEach(coffee=>{
    const balloonContentBody = `
      <div class="balloon-scroll">
        <div class="balloon-content">
          <div class="balloon-header">${coffee.name}</div>
          <div class="balloon-address">${coffee.address}</div>
          <div class="balloon-description">${coffee.description}</div>
          ${coffee.telegramEmbed ? `<iframe class="telegram-embed" src="${coffee.telegramEmbed}"></iframe>` : ''}
          <div class="balloon-footer">
            <button class="balloon-btn" onclick="openRoute(${coffee.coordinates[0]},${coffee.coordinates[1]})">Маршрут</button>
          </div>
        </div>
      </div>`;
    
    const placemark = new ymaps.Placemark(coffee.coordinates,{
      balloonContentHeader: coffee.name,
      balloonContentBody: balloonContentBody
    },{
      iconLayout:'default#image',
      iconImageHref:'https://cdn-icons-png.flaticon.com/512/415/415733.png', // иконка чашки
      iconImageSize:[32,32],
      iconImageOffset:[-16,-16]
    });
    
    coffeePlaces.push({id:coffee.id,placemark,data:coffee});
    clusterer.add(placemark);
    placemark.events.add('click',()=>{highlightCoffeeItem(coffee.id);});
  });
  map.geoObjects.add(clusterer);
}

// ✅ сортировка списка кофеен
function renderCoffeeList(sortBy='name'){
  const list=document.querySelector('.coffee-list');
  list.innerHTML='';

  let sortedData=[...coffeeData];
  if(sortBy==='name'){sortedData.sort((a,b)=>a.name.localeCompare(b.name));}
  if(sortBy==='distance' && userCoords){
    sortedData.sort((a,b)=>{
      const da=ymaps.coordSystem.geo.getDistance(a.coordinates,userCoords);
      const db=ymaps.coordSystem.geo.getDistance(b.coordinates,userCoords);
      return da-db;
    });
  }

  sortedData.forEach(coffee=>{
    const li=document.createElement('li');
    li.className='coffee-item'; li.dataset.id=coffee.id;
    li.innerHTML=`<div class="coffee-name">${coffee.name}</div><div class="coffee-address">${coffee.address}</div>`;
    li.addEventListener('click',()=>{
      const cp=coffeePlaces.find(c=>c.id===coffee.id);
      if(cp){map.setCenter(cp.placemark.geometry.getCoordinates(),16); cp.placemark.balloon.open(); highlightCoffeeItem(coffee.id);}
    });
    list.appendChild(li);
  });
}

function highlightCoffeeItem(id){
  document.querySelectorAll('.coffee-item').forEach(i=>i.classList.remove('active'));
  const selected=document.querySelector(`.coffee-item[data-id="${id}"]`);
  if(selected){selected.classList.add('active'); selected.scrollIntoView({behavior:'smooth',block:'nearest'});}
}

function initEventHandlers(){
  document.querySelector('.search-box').addEventListener('input',applyFilters);
  document.querySelectorAll('.filter-btn').forEach(btn=>btn.addEventListener('click',function(){
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active');
    applyFilters();
  }));
  document.getElementById('metro-filter').addEventListener('change',applyFilters);

  // обработчик сортировки
  document.getElementById('sort-select').addEventListener('change',function(){
    renderCoffeeList(this.value);
  });

  document.querySelector('.user-location-btn').addEventListener('click',locateUser);
}

function applyFilters(){
  const searchText=document.querySelector('.search-box').value.toLowerCase();
  const activeFilter=document.querySelector('.filter-btn.active').dataset.filter;
  const metroVal=document.getElementById('metro-filter').value;
  const radiusMeters=800;
  let metroCoords=null;

  if(metroCircle){map.geoObjects.remove(metroCircle); metroCircle=null;}
  if(metroVal){
    metroCoords=metroVal.split(',').map(Number);
    metroCircle=new ymaps.Circle([metroCoords,radiusMeters],{}, {fillColor:'#DB709380',strokeColor:'#990066',strokeWidth:1});
    map.geoObjects.add(metroCircle);
  }

  coffeePlaces.forEach(cp=>{
    const name=cp.data.name.toLowerCase(), addr=cp.data.address.toLowerCase();
    let visible=true;

    if(searchText && !name.includes(searchText) && !addr.includes(searchText)) visible=false;
    if(activeFilter!=='all' && !cp.data.tags.includes(activeFilter)) visible=false;
    if(metroCoords){
      const dist=ymaps.coordSystem.geo.getDistance(cp.data.coordinates,metroCoords);
      if(dist>radiusMeters) visible=false;
    }

    cp.placemark.options.set('visible',visible);
    const li=document.querySelector(`.coffee-item[data-id="${cp.id}"]`);
    if(li) li.style.display=visible?'block':'none';
  });
}

function locateUser(){
  if(!navigator.geolocation){alert("Геолокация не поддерживается вашим браузером."); return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    userCoords=[pos.coords.latitude,pos.coords.longitude];
    addUserMarker(userCoords);
  },err=>{console.error("Ошибка геолокации:",err); alert("Не удалось определить местоположение.");},{enableHighAccuracy:true,timeout:5000});
}

function addUserMarker(coords){
  if(userMarker){map.geoObjects.remove(userMarker);}
  userMarker=new ymaps.Placemark(coords,{balloonContent:'Вы здесь'},{preset:'islands#circleIcon',iconColor:'#3399ff'});
  map.geoObjects.add(userMarker); map.setCenter(coords,14,{duration:500});
}

// Открываем маршрут в новой вкладке через Яндекс.Карты
function openRoute(lat, lon){
  if(!userCoords){
    alert("Сначала определите ваше местоположение!");
    return;
  }
  const url = `https://yandex.ru/maps/?rtext=${userCoords[0]},${userCoords[1]}~${lat},${lon}&rtt=auto`;
  window.open(url,'_blank');
}
</script>
</body>
</html>
